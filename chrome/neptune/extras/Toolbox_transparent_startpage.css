:root {
	--ex-theme-toolbox-height: calc(var(--urlbar-min-height) + 2 * var(--theme-browser-toolbox-padding));
	--ex-theme-tabsToolbar-height: calc(var(--tab-min-height) + 2 * var(--tab-overflow-clip-margin) + var(--theme-browser-toolbox-padding) / 2);
	--ex-theme-bookmarksbar-height: calc(var(--size-item-small) + 2 * var(--bookmark-block-padding));
	--ex-theme-sidebar-collapsed-width: calc(var(--size-item-large) + 2 * var(--button-outer-padding-inline));
	--ex-theme-sidebar-width: 20em;
	--ex-theme-sidebar-box-width: 24em;
	--ex-theme-sidebar-chat-box-width: 32em;
	--button-outer-padding-inline: calc(((var(--tab-min-height) + 2 * var(--space-medium)) - var(--urlbar-min-height)) / 2);
}

@media not -moz-pref("sidebar.verticalTabs") {
	#navigator-toolbox:has(tab:not(tab-split-view-wrapper > tab)[selected]:is([label="New Tab"], [label="New Private Tab"])) {
		--browser-area-z-index-toolbox: 3;
		position: fixed !important;
		background-color: transparent !important;
		backdrop-filter: blur(2px);
		width: 100%;

		.urlbar > .urlbar-background {
			background-color: light-dark(#ffffff33, #ffffff26) !important;

			&:not(.urlbar[open] > &) {
				border: 1px solid var(--border-color-card) !important;
			}

			.urlbar:hover > & {
				background-color: light-dark(#ffffff4c, #ffffff33) !important;
			}

			.urlbar:is([focused], [open]) > & {
				background-color: light-dark(#ffffff26, #ffffff19) !important;
				backdrop-filter: saturate(1.2) blur(0.5em);
			}
		}

		#tabbrowser-tabs[orient="horizontal"] :is(.tab-group-label, .tabbrowser-tab .tab-background[selected]) {
			opacity: 0.5;

			@media (prefers-color-scheme: dark) {
				opacity: 0.35;
			}
		}

		+ #browser > #tabbrowser-tabbox .dialogBox[sizeto="available"] {
			--box-max-height-default: clamp(80%, 100% + (32em - 100%) / 2, 100%) !important;
			margin-top: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-tabsToolbar-height) + var(--ex-theme-bookmarksbar-height)) !important;
		}

		+ #browser > #tabbrowser-tabbox findbar {
			background-image: none !important;
			position: absolute;
			inset-block-start: calc(var(--ex-theme-tabsToolbar-height) + var(--ex-theme-toolbox-height));
			width: 100%;
		}

		+ #browser > #tabbrowser-tabbox #screenshotsPagePanel {
			inset-block-start: calc(var(--ex-theme-tabsToolbar-height) + var(--ex-theme-toolbox-height));

			> screenshots-buttons {
				background-color: transparent !important;
				padding: 0 !important;
			}
		}

		&:has(#PersonalToolbar:not([collapsed])) + #browser > #tabbrowser-tabbox :is(findbar, #screenshotsPagePanel) {
			inset-block-start: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-tabsToolbar-height) + var(--ex-theme-bookmarksbar-height));
		}

		+ #browser > #sidebar-main:not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - var(--ex-theme-sidebar-collapsed-width));
			inset-inline-start: var(--ex-theme-sidebar-collapsed-width);
		}

		+ #browser > #sidebar-box:not([sidebarcommand="viewGenaiChatSidebar"]):not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - var(--ex-theme-sidebar-box-width) - var(--ex-theme-sidebar-collapsed-width));
			inset-inline-start: calc(var(--ex-theme-sidebar-box-width) + var(--ex-theme-sidebar-collapsed-width));
		}

		+ #browser > #sidebar-box[sidebarcommand="viewGenaiChatSidebar"]:not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - (var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-collapsed-width)));
			inset-inline-start: calc(var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-collapsed-width));
		}

		+ #browser > :is(#sidebar-main, #sidebar-box) {
			position: absolute !important;
			inset-block-start: calc(var(--ex-theme-tabsToolbar-height) + var(--ex-theme-toolbox-height));
			height: calc(100% - (var(--ex-theme-tabsToolbar-height) + var(--ex-theme-toolbox-height)));
			transition: inset 250ms ease-out, height 250ms ease-out;
			backdrop-filter: blur(0.5em);
			
			&[sidebar-positionend]:not([hidden]) ~ #tabbrowser-tabbox findbar {
				inset-inline-start: 0;
			}
		}

		+ #browser > #sidebar-main {
			z-index: var(--browser-stack-z-index-rdm-toolbar);

			&[sidebar-positionend] {
				inset-inline-end: 0;
				
				~ #sidebar-box:not([sidebarcommand="viewGenaiChatSidebar"]) {
					inset-inline-start: calc(100% - (var(--ex-theme-sidebar-box-width) + var(--ex-theme-sidebar-collapsed-width)));
				}

				~ #sidebar-box[sidebarcommand="viewGenaiChatSidebar"] {
					inset-inline-start: calc(100%  - (var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-collapsed-width)));
				}
			}
		}

		+ #browser > #sidebar-box {
			z-index: var(--browser-area-z-index-toolbox-while-animating) !important;
			inset-inline-start: var(--ex-theme-sidebar-collapsed-width);

			&:not([sidebarcommand="viewGenaiChatSidebar"]) {
				max-width: var(--ex-theme-sidebar-box-width) !important;
			}

			&[sidebarcommand="viewGenaiChatSidebar"] {
				min-width: var(--ex-theme-sidebar-chat-box-width) !important;
				max-width: var(--ex-theme-sidebar-chat-box-width) !important;
			}

			+ .sidebar-splitter {
				display: none;
			}
		}

		&:has(#PersonalToolbar:not([collapsed])) + #browser > :is(#sidebar-main, #sidebar-box) {
			inset-block-start: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-tabsToolbar-height) + var(--ex-theme-bookmarksbar-height));
			height: calc(100% - (var(--ex-theme-toolbox-height) + var(--ex-theme-tabsToolbar-height) + var(--ex-theme-bookmarksbar-height)));
		}

		&:has(#tabbrowser-tabs[orient="horizontal"] .tabbrowser-tab:not(tab-group > tab):only-of-type) {
			+ #browser > #tabbrowser-tabbox :is(findbar, #screenshotsPagePanel) {
				inset-block-start: var(--ex-theme-toolbox-height);
			}

			&:has(#PersonalToolbar:not([collapsed])) + #browser > #tabbrowser-tabbox :is(findbar, #screenshotsPagePanel) {
				inset-block-start: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-bookmarksbar-height));
			}

			+ #browser > :is(#sidebar-main, #sidebar-box) {
				inset-block-start: var(--ex-theme-toolbox-height);
				height: calc(100% - var(--ex-theme-toolbox-height));
			}

			&:has(#PersonalToolbar:not([collapsed])) + #browser > :is(#sidebar-main, #sidebar-box) {
				inset-block-start: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-bookmarksbar-height));
				height: calc(100% - (var(--ex-theme-toolbox-height) + var(--ex-theme-bookmarksbar-height)));
			}
		}
	}
}

@media -moz-pref("sidebar.verticalTabs") {
	#navigator-toolbox:has(+ #browser #vertical-tabs tab:not(tab-split-view-wrapper > tab)[selected]:is([label="New Tab"], [label="New Private Tab"])) {
		--browser-area-z-index-toolbox: 3;
		position: fixed !important;
		background-color: transparent !important;
		backdrop-filter: blur(2px);
		width: 100%;

		.urlbar > .urlbar-background {
			background-color: light-dark(#ffffff33, #ffffff26) !important;

			&:not(.urlbar[open] > &) {
				border: 1px solid var(--border-color-card) !important;
			}

			.urlbar:hover > & {
				background-color: light-dark(#ffffff4c, #ffffff33) !important;
			}

			.urlbar:is([focused], [open]) > & {
				background-color: light-dark(#ffffff26, #ffffff19) !important;
				backdrop-filter: saturate(1.2) blur(0.5em);
			}
		}

		+ #browser > #tabbrowser-tabbox .dialogBox[sizeto="available"] {
			--box-max-width-default: clamp(60%, 100% + (32em - 100%) / 2, 100%) !important;
			--box-max-height-default: clamp(80%, 100% + (32em - 100%) / 2, 100%) !important;
			margin-top: calc(var(--ex-theme-toolbox-height) + var(--space-xxlarge)) !important;
		}

		+ #browser > #tabbrowser-tabbox findbar {
			position: absolute;
			background-image: none !important;
			inset-block-start: var(--ex-theme-toolbox-height);
			width: 100%;
		}

		+ #browser > #tabbrowser-tabbox #screenshotsPagePanel {
			inset-block-start: var(--ex-theme-toolbox-height);

			> screenshots-buttons {
				background-color: transparent !important;
				padding: 0 !important;
			}
		}

		&:has(#PersonalToolbar:not([collapsed])) + #browser > #tabbrowser-tabbox :is(findbar, #screenshotsPagePanel) {
			inset-block-start: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-bookmarksbar-height));
		}

		+ #browser > #sidebar-main:not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - var(--ex-theme-sidebar-collapsed-width));
			inset-inline-start: var(--ex-theme-sidebar-collapsed-width);
		}

		+ #browser > #sidebar-main[sidebar-launcher-expanded]:not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - var(--ex-theme-sidebar-width));
			inset-inline-start: var(--ex-theme-sidebar-width);
		}

		+ #browser > #sidebar-box:not([sidebarcommand="viewGenaiChatSidebar"]):not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - (var(--ex-theme-sidebar-box-width) + var(--ex-theme-sidebar-collapsed-width)));
			inset-inline-start: calc(var(--ex-theme-sidebar-box-width) + var(--ex-theme-sidebar-collapsed-width));
		}

		+ #browser > #sidebar-main[sidebar-launcher-expanded]:not([hidden]) ~ #sidebar-box:not([sidebarcommand="viewGenaiChatSidebar"]):not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - (var(--ex-theme-sidebar-width) + var(--ex-theme-sidebar-box-width)));
			inset-inline-start: calc(var(--ex-theme-sidebar-width) + var(--ex-theme-sidebar-box-width));
		}

		+ #browser > #sidebar-box[sidebarcommand="viewGenaiChatSidebar"]:not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - (var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-collapsed-width)));
			inset-inline-start: calc(var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-collapsed-width));
		}

		+ #browser > #sidebar-main[sidebar-launcher-expanded]:not([hidden]) ~ #sidebar-box[sidebarcommand="viewGenaiChatSidebar"]:not([hidden]) ~ #tabbrowser-tabbox findbar {
			width: calc(100% - (var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-width)));
			inset-inline-start: calc(var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-width));
		}

		+ #browser > #sidebar-main[sidebar-launcher-expanded][sidebar-positionend]:not([hidden]) ~ #sidebar-box[sidebar-positionend]:not([hidden]) ~ #tabbrowser-tabbox findbar {
			inset-inline-start: 0;
		}

		+ #browser > :is(#sidebar-main, #sidebar-box) {
			position: absolute !important;
			inset-block-start: var(--ex-theme-toolbox-height) !important;
			height: calc(100% - var(--ex-theme-toolbox-height));
			transition: inset 250ms ease-out, height 250ms ease-out;
			backdrop-filter: blur(0.5em);

			&[sidebar-positionend]:not([hidden]) ~ #tabbrowser-tabbox findbar {
				inset-inline-start: 0;
			}
		}

		&:has(#PersonalToolbar:not([collapsed])) + #browser > :is(#sidebar-main, #sidebar-box) {
			inset-block-start: calc(var(--ex-theme-toolbox-height) + var(--ex-theme-bookmarksbar-height)) !important;
			height: calc(100% - (var(--ex-theme-toolbox-height) + var(--ex-theme-bookmarksbar-height)));
		}

		+ #browser > #sidebar-main {
			z-index: var(--browser-stack-z-index-rdm-toolbar);

			:root[sidebar-expand-on-hover] & {
				background: none !important;
				border: none !important;
			}

			&:not([sidebar-launcher-expanded]) ~ #sidebar-box {
				z-index: var(--browser-area-z-index-toolbox-while-animating) !important;
				inset-inline-start: var(--ex-theme-sidebar-collapsed-width);

				&[sidebar-positionend]:not([sidebarcommand="viewGenaiChatSidebar"]) {
					inset-inline-start: calc(100% - (var(--ex-theme-sidebar-box-width) + var(--ex-theme-sidebar-collapsed-width)));
				}

				&:not([sidebarcommand="viewGenaiChatSidebar"]) {
					width: var(--ex-theme-sidebar-box-width) !important;
					max-width: var(--ex-theme-sidebar-box-width) !important;
				}

				&[sidebarcommand="viewGenaiChatSidebar"] {
						min-width: var(--ex-theme-sidebar-chat-box-width) !important;
						max-width: var(--ex-theme-sidebar-chat-box-width) !important;

						&[sidebar-positionend] {
							inset-inline-start: calc(100% - (var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-collapsed-width)));
						}
				}

				+ .sidebar-splitter {
					display: none;
				}
			}

			&[sidebar-launcher-expanded] {
				width: var(--ex-theme-sidebar-width) !important;
				max-width: var(--ex-theme-sidebar-width) !important;

				~ #sidebar-box {
					z-index: var(--browser-area-z-index-toolbox-while-animating) !important;
					inset-inline-start: var(--ex-theme-sidebar-width);
					
					&[sidebar-positionend]:not([sidebarcommand="viewGenaiChatSidebar"]) {
						inset-inline-start: calc(100% - (var(--ex-theme-sidebar-width) + var(--ex-theme-sidebar-box-width)));
					}

					&:not([sidebarcommand="viewGenaiChatSidebar"]) {
						width: var(--ex-theme-sidebar-box-width) !important;
						max-width: var(--ex-theme-sidebar-box-width) !important;
					}

					&[sidebarcommand="viewGenaiChatSidebar"] {
						min-width: var(--ex-theme-sidebar-chat-box-width) !important;
						max-width: var(--ex-theme-sidebar-chat-box-width) !important;

						&[sidebar-positionend] {
							inset-inline-start: calc(100% - (var(--ex-theme-sidebar-chat-box-width) + var(--ex-theme-sidebar-width)));
						}
					}

					+ .sidebar-splitter {
						display: none;
					}
				}
			}

			&[sidebar-positionend] {
				inset-inline-end: 0;
			}

			+ #sidebar-launcher-splitter {
				display: none;
			}
		}
	}
}